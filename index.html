<html>

<head>
    <title>Leaflet Demo</title>

    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>

    <link rel="stylesheet" href="https://rawgit.com/Leaflet/Leaflet.markercluster/v0.4.0/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://rawgit.com/Leaflet/Leaflet.markercluster/v0.4.0/dist/MarkerCluster.Default.css" />
    <script src="https://rawgit.com/Leaflet/Leaflet.markercluster/v0.4.0/dist/leaflet.markercluster.js"></script>

    <script src="https://rawgit.com/pa7/heatmap.js/v2.0/build/heatmap.min.js"></script>
    <script src="https://rawgit.com/pa7/heatmap.js/v2.0/plugins/leaflet-heatmap.js"></script>

    <style>
        body {
            margin: 0px;
        }
        
        #map {
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script>
        var map = L.map('map').setView([45.1, 5.7], 10);
        var osm = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var markers = L.markerClusterGroup().addTo(map);

        var heatmapLayer = new HeatmapOverlay({
            radius: 30,
            maxOpacity: 0.5,
            scaleRadius: false,
            useLocalExtrema: false,
            valueField: 'capacity'
        });
        map.addLayer(heatmapLayer);

        L.control.layers(null, {
            'Restaurants': markers,
            'Parkings': heatmapLayer
        }).addTo(map);

        /*var restaurantsQuery =
            '[out:json];' +
            'area' +
            '   ["name"="Grenoble"]' +
            '   ["type"="boundary"]' +
            '   ["admin_level"="7"];' +
            'node(area)' +
            '   ["amenity"~"bar|cafe|fast_food|pub|restaurant"];' +
            'out body;';

        var restaurantsUrl = 'http://overpass-api.de/api/interpreter?data=' + encodeURIComponent(restaurantsQuery);*/

        var restaurantsUrl = 'data/restaurants.json';

        var restaurantsRequest = new XMLHttpRequest();
        restaurantsRequest.onreadystatechange = function () {
            if (restaurantsRequest.readyState == 4 && restaurantsRequest.status == 200) {
                var result = JSON.parse(restaurantsRequest.responseText);
                console.log('Restaurants: ', result);

                markers.addLayers(
                    result.elements.map(function (element) {
                        return L.marker([element.lat, element.lon])
                            .bindPopup(element.tags.name);
                    })
                );
            }
        };

        restaurantsRequest.open('GET', restaurantsUrl, true);
        restaurantsRequest.send();

        /*var parkingsQuery =
            '[out:json];' +
            'area' +
            '    ["name"="Grenoble"]' +
            '    ["type"="boundary"]' +
            '    ["admin_level"="7"];' +
            '(' +
            '    node(area)' +
            '        ["amenity"="parking"];' +
            '    way' +
            '        ["amenity"="parking"]' +
            '        (44.93661287504354,5.532989501953125,45.31256326358576,5.9710693359375);' +
            ');' +
            'out body center;';

        var parkingsUrl = 'http://overpass-api.de/api/interpreter?data=' + encodeURIComponent(parkingsQuery);*/

        var parkingsUrl = 'data/parkings.json';

        var parkingsRequest = new XMLHttpRequest();
        parkingsRequest.onreadystatechange = function () {
            if (parkingsRequest.readyState == 4 && parkingsRequest.status == 200) {
                var result = JSON.parse(parkingsRequest.responseText);
                console.log('Parkings: ', result);

                var data = result.elements.map(function (element) {
                    return {
                        lat: element.lat || element.center.lat,
                        lng: element.lon || element.center.lon,
                        capacity: element.tags.capacity || 5
                    };
                })
                heatmapLayer.setData({
                    max: 10,
                    data: data
                });
            }
        };

        parkingsRequest.open('GET', parkingsUrl, true);
        parkingsRequest.send();
    </script>
</body>

</html>